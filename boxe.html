<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITAN BOXE SUPREME - FULL ENGINE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@700&family=Inter:wght@900&display=swap');
        :root { --p-color: #FFD700; --s-color: #00F0FF; --crit: #FF0055; }
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; height: 100dvh; margin: 0; }
        
        .game-canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; transform: scaleX(-1); }
        .video-hidden { position: absolute; opacity: 0; pointer-events: none; }
        
        /* FILTRO CRT DE ÚLTIMA GERAÇÃO */
        .crt-overlay {
            position: fixed; inset: 0; z-index: 50; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 3px, 3px 100%;
        }

        /* EFEITOS VISUAIS */
        .crit-shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-4px, 0, 0); } 20%, 80% { transform: translate3d(8px, 0, 0); } }

        /* HUD TÉCNICO */
        .hud-text { font-family: 'Fira Code', monospace; text-shadow: 0 0 20px var(--p-color); }
        .power-bar-container { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 200px; height: 10px; background: #333; border-radius: 5px; z-index: 90; overflow: hidden; }
        .power-fill { height: 100%; background: linear-gradient(90deg, #fff, var(--p-color)); width: 0%; transition: width 0.1s; }
        
        /* ALERTAS */
        #guard-alert { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 1.5rem; font-weight: 900; display: none; z-index: 100; text-shadow: 0 0 10px red; text-align: center; }
        #form-alert { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); color: #00F0FF; font-size: 1.2rem; font-weight: 900; display: none; z-index: 100; text-shadow: 0 0 10px cyan; text-align: center; animation: pulse 0.5s infinite; }
        
        #start-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }
        
        #timer-box { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; font-weight: bold; z-index: 90; color: white; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div id="start-overlay" onclick="startGame()">
        <i class="fas fa-play-circle text-6xl text-cyan-400 mb-4 animate-pulse"></i>
        <h1 class="text-3xl font-black italic">AUTHENTICATE SYSTEM</h1>
        <p class="text-zinc-500 text-xs mt-2 uppercase tracking-widest text-center">Iniciando Biometria Avançada e Áudio Engine</p>
    </div>

    <div id="flash" class="fixed inset-0 pointer-events-none z-[100] opacity-0 transition-opacity duration-100 bg-white"></div>
    <div id="guard-alert">LEVANTE A GUARDA!</div>
    <div id="form-alert">ESTIQUE O BRAÇO!</div>
    <div id="timer-box">60s</div>

    <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-[90] pointer-events-none">
        <div>
            <span class="text-[10px] uppercase font-bold text-cyan-400">Score</span>
            <h1 id="score" class="text-5xl font-black hud-text text-titan-primary">0000</h1>
        </div>
        <div class="text-right">
            <span class="text-[10px] uppercase font-bold text-cyan-400">Extensão</span>
            <h1 id="last-angle" class="text-4xl font-black hud-text text-white">0°</h1>
        </div>
    </div>

    <div class="power-bar-container">
        <div id="power-meter" class="power-fill"></div>
    </div>

    <div class="relative w-full h-full" id="game-container">
        <video id="webcam" class="video-hidden" playsinline webkit-playsinline muted autoplay></video>
        <canvas id="gameCanvas" class="game-canvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('webcam');
        
        let state = {
            active: false,
            score: 0,
            targets: [],
            particles: [], // ENGINE DE PARTÍCULAS
            lastHands: { left: {x:0, y:0}, right: {x:0, y:0} },
            guardTimer: 0,
            timeLeft: 60,
            angles: { left: 0, right: 0 }
        };

        // --- SISTEMA DE PARTÍCULAS (DESIGN DE ALTO NÍVEL) ---
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 4 + 2;
                this.speedX = (Math.random() - 0.5) * 12;
                this.speedY = (Math.random() - 0.5) * 12;
                this.alpha = 1;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                this.alpha -= 0.025;
            }
            draw() {
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 10; ctx.shadowColor = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        // --- INTERPOLAÇÃO LERP (SUAVIZAÇÃO) ---
        let smoothLandmarks = null;
        const lerp = (a, b, f) => a + (b - a) * f;

        const TitanAudio = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            impact: function() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            },
            score: function() {
                this.playTone(800, 'sine', 0.1, 0.05);
                setTimeout(() => this.playTone(1200, 'sine', 0.2, 0.05), 100);
            },
            crit: function() {
                this.impact();
                this.playTone(200, 'sawtooth', 0.3, 0.1);
            },
            speak: function(text) {
                if('speechSynthesis' in window) {
                    const msg = new SpeechSynthesisUtterance(text);
                    msg.lang = 'en-US'; msg.pitch = 0.8; msg.rate = 1.1;
                    window.speechSynthesis.speak(msg);
                }
            }
        };

        function startGame() {
            TitanAudio.init();
            TitanAudio.speak("Titan System Online. Fight!");
            document.getElementById('start-overlay').style.display = 'none';
            const camera = new Camera(video, { onFrame: async () => await pose.send({image: video}), width: 640, height: 480 });
            camera.start().then(() => {
                state.active = true;
                spawnTarget();
                startTimer();
            });
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
        pose.onResults(onResults);

        function startTimer() {
            const timerInterval = setInterval(() => {
                if(!state.active) { clearInterval(timerInterval); return; }
                state.timeLeft--;
                document.getElementById('timer-box').innerText = state.timeLeft + 's';
                if(state.timeLeft <= 5 && state.timeLeft > 0) TitanAudio.playTone(400, 'square', 0.1);
                if(state.timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(state.score);
                }
            }, 1000);
        }

        function spawnTarget() {
            if(!state.active) return;
            const side = Math.random() > 0.5 ? 'left' : 'right';
            state.targets.push({
                x: side === 'left' ? 0.25 : 0.75,
                y: 0.3 + (Math.random() * 0.3),
                r: 10, maxR: 90, side, color: side === 'left' ? '#00F0FF' : '#FFD700'
            });
            setTimeout(spawnTarget, Math.max(800, 1500 - (state.score / 20)));
        }

        function calculateAngle(a, b, c) {
            const AB = Math.sqrt(Math.pow(b.x - a.x, 2) + Math.pow(b.y - a.y, 2));
            const BC = Math.sqrt(Math.pow(b.x - c.x, 2) + Math.pow(b.y - c.y, 2));
            const AC = Math.sqrt(Math.pow(c.x - a.x, 2) + Math.pow(c.y - a.y, 2));
            return Math.acos((BC*BC + AB*AB - AC*AC) / (2*BC*AB)) * (180/Math.PI);
        }

        function onResults(res) {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            
            // DESIGN SUPREME: Efeito de Rastro (Ghosting)
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.fillRect(0,0,canvas.width, canvas.height);
            
            ctx.save();
            ctx.scale(-1, 1);
            ctx.translate(-canvas.width, 0);
            ctx.globalAlpha = 0.5; // Vídeo semi-transparente para focar no neon
            ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            if (res.poseLandmarks) {
                // APLICAÇÃO DE LERP PARA MOVIMENTAÇÃO FLUÍDA
                if (!smoothLandmarks) smoothLandmarks = res.poseLandmarks;
                else {
                    smoothLandmarks = res.poseLandmarks.map((lm, i) => ({
                        x: lerp(smoothLandmarks[i].x, lm.x, 0.25),
                        y: lerp(smoothLandmarks[i].y, lm.y, 0.25),
                        visibility: lm.visibility
                    }));
                }

                const lm = smoothLandmarks;
                const leftArm = { shoulder: lm[11], elbow: lm[13], wrist: lm[15] };
                const rightArm = { shoulder: lm[12], elbow: lm[14], wrist: lm[16] };

                state.angles.left = calculateAngle(leftArm.shoulder, leftArm.elbow, leftArm.wrist);
                state.angles.right = calculateAngle(rightArm.shoulder, rightArm.elbow, rightArm.wrist);

                if(state.active) {
                    checkGuard(leftArm.wrist, rightArm.wrist, leftArm.shoulder, rightArm.shoulder);
                    processPhysics(leftArm.wrist, rightArm.wrist);
                }
                drawSupremeSkeleton(lm);
            }

            // ATUALIZA E DESENHA PARTÍCULAS
            state.particles.forEach((p, i) => {
                p.update(); p.draw();
                if(p.alpha <= 0) state.particles.splice(i, 1);
            });

            renderTargets();
            ctx.globalAlpha = 1.0;
        }

        function drawSupremeSkeleton(lm) {
            ctx.lineWidth = 4;
            ctx.shadowBlur = 15;
            const connect = (a, b, color) => {
                const p1 = lm[a]; const p2 = lm[b];
                ctx.beginPath();
                ctx.strokeStyle = color; ctx.shadowColor = color;
                ctx.moveTo((1 - p1.x) * canvas.width, p1.y * canvas.height);
                ctx.lineTo((1 - p2.x) * canvas.width, p2.y * canvas.height);
                ctx.stroke();
            };
            connect(11, 13, "#00F0FF"); connect(13, 15, "#00F0FF"); 
            connect(12, 14, "#FFD700"); connect(14, 16, "#FFD700"); 
            ctx.shadowBlur = 0;
        }

        function processPhysics(lw, rw) {
            const hands = { left: lw, right: rw };
            const velLeft = Math.hypot(hands.left.x - state.lastHands.left.x, hands.left.y - state.lastHands.left.y);
            const velRight = Math.hypot(hands.right.x - state.lastHands.right.x, hands.right.y - state.lastHands.right.y);
            const maxVel = Math.max(velLeft, velRight);
            const force = Math.min(maxVel * 1000, 100);
            document.getElementById('power-meter').style.width = force + "%";

            state.targets.forEach((t, i) => {
                const hand = t.side === 'left' ? hands.left : hands.right;
                const angle = t.side === 'left' ? state.angles.left : state.angles.right; 
                const hX = (1 - hand.x) * canvas.width; 
                const hY = hand.y * canvas.height;
                const d = Math.hypot(hX - (t.x * canvas.width), hY - (t.y * canvas.height));

                if (d < 120 && force > 15) {
                    if (angle > 140) {
                        let points = 100;
                        if (force > 50) {
                            points = 300; TitanAudio.crit();
                            document.getElementById('game-container').classList.add('crit-shake');
                            setTimeout(()=>document.getElementById('game-container').classList.remove('crit-shake'), 200);
                            document.getElementById('flash').style.opacity = 0.5;
                            setTimeout(()=>document.getElementById('flash').style.opacity = 0, 100);
                        } else { TitanAudio.score(); }
                        
                        // EXPLOSÃO DE PARTÍCULAS NO IMPACTO
                        for(let j=0; j<15; j++) state.particles.push(new Particle(t.x * canvas.width, t.y * canvas.height, t.color));

                        state.score += points;
                        document.getElementById('last-angle').innerText = Math.round(angle) + "°";
                        state.targets.splice(i, 1);
                        document.getElementById('score').innerText = state.score.toString().padStart(4, '0');
                    } else {
                        document.getElementById('form-alert').style.display = 'block';
                        setTimeout(() => document.getElementById('form-alert').style.display = 'none', 500);
                    }
                }
            });
            state.lastHands = { left: {...hands.left}, right: {...hands.right} };
        }

        function renderTargets() {
            state.targets.forEach(t => {
                t.r += (t.maxR - t.r) * 0.1;
                ctx.shadowBlur = 20; ctx.shadowColor = t.color;
                ctx.strokeStyle = t.color; ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.arc(t.x * canvas.width, t.y * canvas.height, t.r, 0, Math.PI * 2);
                ctx.stroke();
            });
            ctx.shadowBlur = 0;
        }

        function checkGuard(lw, rw, ls, rs) {
            const handsY = (lw.y + rw.y) / 2;
            const shoulderY = (ls.y + rs.y) / 2;
            if (handsY > shoulderY + 0.3) { 
                state.guardTimer++;
                if (state.guardTimer > 60) document.getElementById('guard-alert').style.display = 'block';
            } else {
                state.guardTimer = 0;
                document.getElementById('guard-alert').style.display = 'none';
            }
        }

        function endGame(score) {
            state.active = false;
            TitanAudio.speak("Session Complete");
            const recordKey = 'titan_rec_boxe';
            const currentRecord = parseInt(localStorage.getItem(recordKey) || '0');
            if (score > currentRecord) {
                localStorage.setItem(recordKey, score);
                document.getElementById('final-score').innerHTML = score + "<br><span class='text-sm text-yellow-400 animate-pulse'>NOVO RECORDE!</span>";
                setTimeout(() => TitanAudio.speak("New Record! Congratulations agent."), 1000);
            } else { document.getElementById('final-score').innerText = score; }
            let xp = parseInt(localStorage.getItem('titan_xp') || '0');
            localStorage.setItem('titan_xp', xp + Math.floor(score / 10));
            document.getElementById('final-xp').innerText = "+" + Math.floor(score / 10) + " XP";
            document.getElementById('game-over-modal').classList.remove('hidden');
            document.getElementById('game-over-modal').classList.add('flex');
        }
    </script>
</body>
</html>
